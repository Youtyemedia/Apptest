<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collection Details</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', 'Noto Sans', sans-serif; }
        .issue-item { cursor: pointer; transition: background-color 0.2s; }
        .issue-item:hover { background-color: #f0f0f0; }
        .owned-icon { color: #4CAF50; /* Green */ }
        .missing-icon { color: #F44336; /* Red */ }
    </style>
  </head>
  <body>
    <div
      class="relative flex size-full min-h-screen flex-col bg-white justify-between group/design-root overflow-x-hidden"
    >
      <div>
        <!-- Header -->
        <div class="flex items-center bg-white p-4 pb-2 justify-between border-b border-gray-200">
          <a href="mie collezioni.html" class="text-[#171212] flex size-12 shrink-0 items-center" data-icon="ArrowLeft" data-size="24px" data-weight="regular" title="Back to My Collections">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
              <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
            </svg>
          </a>
          <h2 id="collectionNameHeader" class="text-[#171212] text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">Collection Details</h2>
        </div>

        <!-- Collection Info -->
        <div class="flex p-4 @container">
          <div class="flex w-full flex-col gap-4 items-start md:flex-row">
            <div
              id="collectionCoverImage"
              class="bg-center bg-no-repeat aspect-[2/3] bg-cover rounded-xl min-h-32 w-32 md:w-40 flex-shrink-0"
              style='background-image: url("https://via.placeholder.com/300x450.png?text=Loading...");'
            ></div>
            <div class="flex flex-col">
              <p id="collectionName" class="text-[#171212] text-[22px] font-bold leading-tight tracking-[-0.015em]">Loading...</p>
              <p id="collectionVolume" class="text-[#82686a] text-base font-normal leading-normal"></p>
              <p id="collectionYears" class="text-[#82686a] text-base font-normal leading-normal"></p>
            </div>
          </div>
        </div>

        <!-- Collection Progress -->
        <h3 class="text-[#171212] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Collection Progress</h3>
        <div class="flex flex-col gap-1 p-4">
          <div class="flex gap-6 justify-end"><p id="collectionProgressText" class="text-[#171212] text-sm font-normal leading-normal">0/0</p></div>
          <div class="rounded bg-[#e4dddd] h-2"><div id="collectionProgressBar" class="h-2 rounded bg-[#171212]" style="width: 0%;"></div></div>
        </div>

        <!-- Missing Issues -->
        <h3 class="text-[#171212] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Missing Issues</h3>
        <div id="missingIssuesGrid" class="grid grid-cols-[repeat(auto-fit,minmax(158px,1fr))] gap-3 p-4">
          <!-- JS will populate this -->
          <p id="noMissingIssues" class="text-gray-500 col-span-full" style="display:none;">No missing issues!</p>
        </div>

        <!-- Owned Issues -->
        <h3 class="text-[#171212] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Owned Issues</h3>
        <div id="ownedIssuesGrid" class="grid grid-cols-[repeat(auto-fit,minmax(158px,1fr))] gap-3 p-4">
          <!-- JS will populate this -->
          <p id="noOwnedIssues" class="text-gray-500 col-span-full" style="display:none;">No issues owned yet.</p>
        </div>
        <div id="errorMessage" class="p-4 text-red-500 text-center" style="display:none;"></div>
      </div>

      <!-- Navigation Bar -->
      <div class="mt-auto">
        <div class="flex gap-2 border-t border-[#f4f1f1] bg-white px-4 pb-3 pt-2">
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 rounded-full text-[#82686a]" href="mie collezioni.html"> <!-- Not active -->
            <div class="text-[#82686a] flex h-8 items-center justify-center" data-icon="House" data-size="24px" data-weight="regular"> <!-- Regular weight for inactive -->
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M216.49,100.29l-80-75.48a16,16,0,0,0-21,0l-80,75.48A16,16,0,0,0,24,115.55V208a16,16,0,0,0,16,16H80a16,16,0,0,0,16-16V160a16,16,0,0,1,16-16h32a16,16,0,0,1,16,16v48a16,16,0,0,0,16,16h40a16,16,0,0,0,16-16V115.55A16,16,0,0,0,216.49,100.29ZM208,208H176V160a32,32,0,0,0-32-32H112a32,32,0,0,0-32,32v48H40V115.55l80-75.48,80,75.48Z"></path></svg>
            </div>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#82686a]" href="#">
            <div class="text-[#82686a] flex h-8 items-center justify-center" data-icon="MagnifyingGlass" data-size="24px" data-weight="regular"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg>
            </div>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#82686a]" href="crea_collezioni_page.html">
            <div class="text-[#82686a] flex h-8 items-center justify-center" data-icon="PlusSquare" data-size="24px" data-weight="regular"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,40H32A16,16,0,0,0,16,56V200a16,16,0,0,0,16,16H224a16,16,0,0,0,16-16V56A16,16,0,0,0,224,40Zm0,160H32V56H224V200ZM128,88a8,8,0,0,1,8,8v24h24a8,8,0,0,1,0,16H136v24a8,8,0,0,1-16,0V136H96a8,8,0,0,1,0-16h24V96A8,8,0,0,1,128,88Z"></path></svg>
            </div>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#82686a]" href="#">
            <div class="text-[#82686a] flex h-8 items-center justify-center" data-icon="BookmarkSimple" data-size="24px" data-weight="regular"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M192,24H64A16,16,0,0,0,48,40V224a8,8,0,0,0,12.48,6.93L128,190l67.52,40.9A8,8,0,0,0,208,224V40A16,16,0,0,0,192,24Zm0,178.42l-59.52-36.07a8,8,0,0,0-9,0L64,202.42V40H192Z"></path></svg>
            </div>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#82686a]" href="#">
            <div class="text-[#82686a] flex h-8 items-center justify-center" data-icon="User" data-size="24px" data-weight="regular"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path></svg>
            </div>
          </a>
        </div>
        <div class="h-5 bg-white"></div>
      </div>
    </div>
    <script>
        const collectionNameHeaderEl = document.getElementById('collectionNameHeader');
        const collectionCoverImageEl = document.getElementById('collectionCoverImage');
        const collectionNameEl = document.getElementById('collectionName');
        const collectionVolumeEl = document.getElementById('collectionVolume');
        const collectionYearsEl = document.getElementById('collectionYears');
        const collectionProgressTextEl = document.getElementById('collectionProgressText');
        const collectionProgressBarEl = document.getElementById('collectionProgressBar');
        const missingIssuesGridEl = document.getElementById('missingIssuesGrid');
        const ownedIssuesGridEl = document.getElementById('ownedIssuesGrid');
        const noMissingIssuesEl = document.getElementById('noMissingIssues');
        const noOwnedIssuesEl = document.getElementById('noOwnedIssues');
        const errorMessageEl = document.getElementById('errorMessage');
        let currentCollectionId = null;
        function getCollectionIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }
        async function fetchCollectionDetails(collectionId) {
            errorMessageEl.style.display = 'none';
            try {
                const response = await fetch(\`/collections/\${collectionId}\`);
                if (!response.ok) {
                    if (response.status === 404) throw new Error('Collection not found.');
                    throw new Error(\`HTTP error! status: \${response.status}\`);
                }
                const data = await response.json();
                displayCollectionDetails(data);
            } catch (error) {
                console.error('Error fetching collection details:', error);
                errorMessageEl.textContent = \`Error: \${error.message}\`;
                errorMessageEl.style.display = 'block';
                collectionNameEl.textContent = 'Error';
                collectionCoverImageEl.style.backgroundImage = 'url("https://via.placeholder.com/300x450.png?text=Error")';
            }
        }
        function displayCollectionDetails(collection) {
            document.title = collection.title + " | Details";
            collectionNameHeaderEl.textContent = collection.title;
            collectionNameEl.textContent = collection.title;
            collectionVolumeEl.textContent = collection.volume || '';
            collectionYearsEl.textContent = collection.publication_years || '';
            if (collection.cover_image_url) {
                collectionCoverImageEl.style.backgroundImage = \`url('\${collection.cover_image_url}')\`;
            } else {
                collectionCoverImageEl.style.backgroundImage = 'url("https://via.placeholder.com/300x450.png?text=' + encodeURIComponent(collection.title) +'")';
            }
            const issues = collection.issues || [];
            const ownedIssues = issues.filter(issue => issue.is_owned);
            const missingIssues = issues.filter(issue => !issue.is_owned);
            const totalIssues = issues.length;
            const numOwned = ownedIssues.length;
            collectionProgressTextEl.textContent = \`\${numOwned}/\${totalIssues}\`;
            const progressPercentage = totalIssues > 0 ? (numOwned / totalIssues) * 100 : 0;
            collectionProgressBarEl.style.width = \`\${progressPercentage}%\`;
            missingIssuesGridEl.innerHTML = '';
            if (missingIssues.length === 0) {
                noMissingIssuesEl.style.display = 'block';
            } else {
                noMissingIssuesEl.style.display = 'none';
                missingIssues.forEach(issue => missingIssuesGridEl.appendChild(createIssueElement(issue, false)));
            }
            ownedIssuesGridEl.innerHTML = '';
            if (ownedIssues.length === 0) {
                noOwnedIssuesEl.style.display = 'block';
            } else {
                noOwnedIssuesEl.style.display = 'none';
                ownedIssues.forEach(issue => ownedIssuesGridEl.appendChild(createIssueElement(issue, true)));
            }
        }
        function createIssueElement(issue, isOwned) {
            const issueDiv = document.createElement('div');
            issueDiv.className = 'issue-item flex flex-1 gap-3 rounded-lg border border-[#e4dddd] bg-white p-3 items-center';
            issueDiv.dataset.issueId = issue.id;
            issueDiv.dataset.isOwned = isOwned;
            const iconDiv = document.createElement('div');
            iconDiv.className = \`text-[#171212] \${isOwned ? 'owned-icon' : 'missing-icon'}\`;
            iconDiv.innerHTML = isOwned
                ? '<svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24a104,104,0,1,0,104,104A104.11,104.11,0,0,0,128,24Zm45.66,85.66-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35a8,8,0,0,1,11.32,11.32Z"></path></svg>'
                : '<svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Z"></path></svg>';
            const titleEl = document.createElement('h2');
            titleEl.className = 'text-[#171212] text-base font-bold leading-tight';
            titleEl.textContent = \`#\${issue.issue_number}\`;
            if (issue.title) {
                titleEl.textContent += \`: \${issue.title}\`;
            }
            issueDiv.appendChild(iconDiv);
            issueDiv.appendChild(titleEl);
            issueDiv.addEventListener('click', () => toggleIssueOwnership(issue.id, !isOwned));
            return issueDiv;
        }
        async function toggleIssueOwnership(issueId, newOwnedStatus) {
            try {
                const response = await fetch(\`/issues/\${issueId}\`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_owned: newOwnedStatus })
                });
                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || \`HTTP error! status: \${response.status}\`);
                }
                if (currentCollectionId) {
                    fetchCollectionDetails(currentCollectionId);
                }
            } catch (error) {
                console.error('Error toggling issue ownership:', error);
                errorMessageEl.textContent = \`Error updating issue: \${error.message}\`;
                errorMessageEl.style.display = 'block';
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            currentCollectionId = getCollectionIdFromUrl();
            if (currentCollectionId) {
                fetchCollectionDetails(currentCollectionId);
            } else {
                collectionNameEl.textContent = 'No Collection ID provided.';
                errorMessageEl.textContent = 'Error: No Collection ID found in URL.';
                errorMessageEl.style.display = 'block';
            }
        });
    </script>
  </body>
</html>
